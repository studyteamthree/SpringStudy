# 7. ìŠ¤í”„ë§ í•µì‹¬ ê¸°ìˆ ì˜ ì‘ìš©

## 7.3 ì„œë¹„ìŠ¤ ì¶”ìƒí™” ì ìš©

- JaxbXmlSqlReaderë¥¼ ê°œì„ í•´ë´…ì‹œë‹¤.

  1. JAXB ì™¸ì—ë„ ë‹¤ì–‘í•œ XMLê³¼ ìë°” ì˜¤ë¸Œì íŠ¸ë¥¼ ë§¤í•‘í•˜ë„ë¡ ê°œì„ 
  2. XML íŒŒì¼ì„ ì¢€ë” ë‹¤ì–‘í•œ ì†ŒìŠ¤ì—ì„œ ê°€ì ¸ì™€ì•¼í•œë‹¤. í˜„ì¬ëŠ” UserDaoì™€ ê°™ì€ í´ë˜ìŠ¤ íŒ¨ìŠ¤ì•ˆì—ì„œë§Œ ì½ì„ ìˆ˜ ìˆëŠ”ë°, ì´ê²ƒì„ ì„ì˜ì˜ í´ë˜ìŠ¤ íŒ¨ìŠ¤, íŒŒì¼ ì‹œìŠ¤í…œì˜ ì ˆëŒ€ê²½ë¡œ, HTTP í”„ë¡œí† ì½œì„ ì´ìš©í•œ ì›ê²© ë“±ì˜ ë°©ë²•ìœ¼ë¡œ í™•ì¥í•  ìˆ˜ ìˆì„ê¹Œ?

  #### 7.3.1 OXM ì„œë¹„ìŠ¤ ì¶”ìƒí™”

  - JavaSE, JavaEE í‘œì¤€ì— í¬í•¨ëœ JAXB ì™¸ì—ë„ ìì£¼ ì‚¬ìš© ë˜ëŠ” XML, ìë°”ì˜¤ë¸Œì íŠ¸ê°„ ë§¤í•‘ ê¸°ìˆ ì´ ë§ë‹¤. ëŒ€í‘œì  ë‹¤ìŒ ë„¤ê°€ì§€ê°€ ìˆë‹¤.

    > Castor XML : ì„¤ì •íŒŒì¼ì´ í•„ìš”ì—†ëŠ” ì¸íŠ¸ë¡œìŠ¤í™ì…˜ ëª¨ë“œë¥¼ ì§€ì›í•˜ëŠ” ê°€ë²¼ìš´ ë°”ì¸ë”© í”„ë ˆì„ì›Œí¬
    >
    > JiBX : ë›°ì–´ë‚œ í¼í¬ë¨¼ìŠ¤ì˜ XML ë°”ì¸ë”© ê¸°ìˆ 
    >
    > XmlBean : ì•„íŒŒì¹˜ XML í”„ë¡œì íŠ¸ì˜ í•˜ë‚˜ì´ë©°, XML ì •ë³´ì…‹ì„ íš¨ê³¼ì ìœ¼ë¡œ ì œê³µí•œë‹¤.
    >
    > Xstream : ê´€ë¡€ë¥¼ ì´ìš©í•œ ì„¤ì •ì—†ëŠ” ë°”ì¸ë”©ì„ ì§€ì›í•˜ëŠ” XML ë°”ì¸ë”© ê¸°ìˆ ì˜ í•˜ë‚˜

  - ìœ„ì˜ ë‹¤ì–‘í•œ OXM í”„ë ˆì„ì›Œí¬ ë“¤ì€ ê¸°ëŠ¥ ë©´ì—ì„œ ìƒí˜¸ í˜¸í™˜ì„±ì´ ìˆìœ¼ë©° ì‚¬ìš© ëª©ì ì´ ë™ì¼í•˜ê¸°ì— ìœ ì‚¬í•œ ê¸°ëŠ¥ ê³¼ APIë¥¼ ì œê³µí•œë‹¤. ê·¸ë ‡ë‹¤ë©´ ì„œë¹„ìŠ¤ ì¶”ìƒí™”ê°€ í•„ìš”í•˜ë‹¤.! :heart_eyes_cat:

    ```
    OXM : Object-XML Mapping, XMLê³¼ ìë°” ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒí˜¸ ë³€í™˜í•´ì£¼ëŠ” ê¸°ìˆ 
    ```

  - ê²Œë‹¤ê°€ ìœ„ëŒ€í•œ :sunny:ìŠ¤:sunflower:í”„:rose:ë§:cherry_blossom:ì€ íŠ¸ëœì­ì…˜, ë©”ì¼ ì „ì†¡ë¿ ì•„ë‹ˆë¼ OXMì— ëŒ€í•´ì„œë„ ì„œë¹„ìŠ¤ ì¶”ìƒí™” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. :sunglasses:

  - OXM ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤

    - ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” OXM ì¶”ìƒí™” ì„œë¹„ìŠ¤ëŠ” Marshaller(Java Object -> XML), ë° Unmarshaller(XML -> Java Object)ê°€ ìˆìœ¼ë©° Sql ReaderëŠ” Unmarshallerë¥¼ ì´ìš©í•œë‹¤.

      ```java
      //javax.xml.bind.unmarshaller ê°€ ì•„ë‹™ë‹ˆë‹¹!
      package org.springframework.oxm;
      
      public interface Unmarshaller {
      
      	//í•´ë‹¹ í´ë˜ìŠ¤ë¡œ ì–¸ë§ˆìƒ¬ì´ ê°€ëŠ¥í•œì§€ í™•ì¸í•´ì¤€ë‹¤. ë³„ë¡œ ì‚¬ìš©í•  ì¼ì€ ì—†ì„ê±°ëë‹ˆë‹¤.
      	boolean supports(Class<?> clazz);
      
      	//sourceë¥¼ í†µí•´ ì œê³µë°›ì€ XMLì„ ìë°” ì˜¤ë¸Œì íŠ¸ íŠ¸ë¦¬ë¡œ ë³€í™˜í•´ì„œ ëŒë ¤ì¤€ë‹¤.
      	Object unmarshal(Source source) throws IOException, XmlMappingException;
      
      }
      ```

    - OXM ê¸°ìˆ ì— ë”°ë¼ Unmarshaller ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ë“¤ì´ ìˆê³  ê° í´ë˜ìŠ¤ëŠ” í•´ë‹¹ ê¸°ìˆ ì—ì„œ í•„ìš”ë¡œ í•˜ëŠ” ì¶”ê°€ ì •ë³´ë¥¼ ë¹ˆ í”„ë¡œí¼í‹°ë¡œ ì§€ì •í•  ìˆ˜ ìˆê²Œ ë˜ì–´ìˆë‹¤.

  - JAXB êµ¬í˜„ í…ŒìŠ¤íŠ¸

    - JaxbTestë¥¼ OXM ì„œë¹„ìŠ¤ ì¶”ìƒí™” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì´ìš©í•˜ë„ë¡ ë§Œë“¤ì.!

    - JAXBë¥¼ ì´ìš©í•˜ëŠ” Unmarshaller êµ¬í˜„ì²´ì¸ Jaxb2Marshallerë¥¼ ì´ìš©í•˜ê¸° ìœ„í•´ OxmTest-context.xmlíŒŒì¼ì„ ë§Œë“¤ê³  ë“±ë¡í•˜ì—¬ ë¹ˆ ì„¤ì •ì„ ë§Œë“¤ì.

      > Jaxb2Marshller í´ë˜ìŠ¤ëŠ” Unmarshaller, Marshallerë¥¼ ëª¨ë‘ êµ¬í˜„í•˜ê³  ìˆê¸° ë•Œë¬¸ì— Unmarshallerë¡œë„ ì´ìš© ê°€ëŠ¥í•˜ë‹¤.

      ```xml
      <?xml version="1.0" encoding="UTF-8"?>
      <beans xmlns="http://www.springframework.org/schema/beans"
      	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">
      
      	 <bean id="unmarshaller" class="org.springframework.oxm.jaxb.Jaxb2Marshaller">
      	 	<property name="contextPath" value="springbook.user.sqlservice.jaxb" />
      	 </bean>
      
      </beans>
      ```

      _org.springframework.oxm-3.0.7RELEASE.jar_ í•„ìš”

    - í…ŒìŠ¤íŠ¸ì½”ë“œë¥¼ ë´…ì‹œë‹¤.

      ```java
      package springbook.learningtest.spring.oxm;
      
      ...
      import org.springframework.oxm.Unmarshaller;
      import javax.xml.transform.stream.StreamSource;
      
      @RunWith(SpringJUnit4ClassRunner.class)
      @ContextConfiguration
      public class OxmTest {
      	@Autowired
      	Unmarshaller unmarshaller;
      	
      	@Test 
      	public void unmarshallSqlMap() throws XmlMappingException, IOException  {
      		Source xmlSource = new StreamSource(getClass().getResourceAsStream("sqlmap.xml"));
      		Sqlmap sqlmap = (Sqlmap)this.unmarshaller.unmarshal(xmlSource);
      		
      		List<SqlType> sqlList = sqlmap.getSql();		
      		assertThat(sqlList.size(), is(3));
      		assertThat(sqlList.get(0).getKey(), is("add"));
      		assertThat(sqlList.get(0).getValue(), is("insert"));
      		assertThat(sqlList.get(1).getKey(), is("get"));
      		assertThat(sqlList.get(1).getValue(), is("select"));
      		assertThat(sqlList.get(2).getKey(), is("delete"));
      		assertThat(sqlList.get(2).getValue(), is("delete"));
      	}
      }
      ```

      XMLì„ ì½ì–´ì„œ ë³€í™˜í•˜ëŠ” ê²ƒì´ ê°„ë‹¨í•´ì¡Œìœ¼ë©° ì´ ì½”ë“œìƒì—ì„œ JAXBë¼ëŠ” êµ¬ì²´ì ì¸ ê¸°ìˆ ì— ì˜ì¡´í•˜ëŠ” ë¶€ë¶„ì€ ì—†ë‹¤. JAXBë¥¼ ë‹¤ë¥¸ ê¸°ìˆ ë¡œ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ ë‹¨ì§€ XMLì˜ ë¹ˆ ì„¤ì •ë§Œ ë³€ê²½í•´ ì£¼ë©´ ëœë‹¤.

  - Caster êµ¬í˜„ í…ŒìŠ¤íŠ¸

    - JAXBë¥¼ Casterë¡œ ë°”ê¿”ë³´ì! casterì—ì„œ í•„ìš”í•œ ë§¤í•‘ì •ë³´ë¥¼ ì¤€ë¹„í•œ í›„ unmarshaller ë¹ˆ ì„¤ì •ë§Œ ë°”ê¿”ì£¼ë©´ ëœë‹¤.

    - ë¹ˆ ì„¤ì •ì„ ë°”ê¿”ë³´ì, Casterìš© ë§¤í•‘ì •ë³´ëŠ” "mapping.xml"ì´ë‹¤

      ```xml
      <bean id="unmarshaller" class="org.springframework.oxm.castor.CastorMarshaller">
      	<property name="mappingLocation" value="springbook/learningtest/spring/oxm/mapping.xml" />
      </bean>
      ```

    - í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ì „í˜€ ë³€í•˜ì§€ ì•Šì•˜ì§€ë§Œ ì˜ ì‹¤í–‰ë  ê²ƒì´ë‹¤.

  - ì¶”ìƒí™”ë¥¼ ì ìš©í•˜ì—¬ í•„ìš”ì— ë”°ë¼ ë¡œìš°ë ˆë²¨ì˜ ê¸°ìˆ ì´ ë³€í•´ë„ ì¼ê´€ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ìœ ì§€ê°€ ê°€ëŠ¥í•˜ë‹¤.

  #### 7.3.2 OXM ì„œë¹„ìŠ¤ ì¶”ìƒí™” ì ìš©

  - ì´ì œ OXMì„ ì´ìš©í•˜ëŠ” OxmSqlServiceë¥¼ ë§Œë“¤ì SqlRegistryëŠ” DI ë°›ê³  SqlReaderëŠ” OXMì˜ ì–¸ë§ˆì‚´ëŸ¬ë¥¼ ì´ìš©í•˜ë„ë¡ ì œí•œí•˜ì—¬ ì‚¬ìš©ì„±ì„ ê·¹ëŒ€í™” í•˜ì.

  - ë©¤ë²„ í´ë˜ìŠ¤ë¥¼ ì°¸ì¡°í•˜ëŠ” í†µí•© í´ë˜ìŠ¤

    - OxmSqlServiceëŠ” BaseSqlServiceì™€ ìœ ì‚¬í•˜ê²Œ SqlReader íƒ€ì…ì˜ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©°, ì´ë¥¼ ìŠ¤íƒœí‹± ë©¤ë²„ í´ë˜ìŠ¤ë¡œ ë‚´ì¥í•˜ì—¬ ìì‹ ë§Œ ì‚¬ìš©í•˜ë„ë¡ ë…ì í•˜ëŠ” êµ¬ì¡°ë¡œ ë§Œë“¤ì–´ë³´ì.

      ![](https://studyteamthree.github.io/SpringStudy/assets/img/7.3.2_OxmSqlServiceClassStructure.png)

  - OxmSqlServiceì™€ OxmSqlReaderëŠ” êµ¬ì¡°ì ìœ¼ë¡œ ê°•í•˜ê²Œ ê²°í•©ë˜ì§€ë§Œ ë…¼ë¦¬ì ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ë¶„ë¦¬ëœë‹¤. ìœ ì—°ì„±ì€ ì¡°ê¸ˆ ì†í•´ë¥¼ ë³´ì§€ë§Œ ë°–ì—ì„œëŠ” í•˜ë‚˜ì˜ Objectë¡œ ë³´ì´ë©° ë‚®ì€ ê²°í•©ë„ë¥¼ ìœ ì§€í•˜ë©° ì‘ì§‘ë„ê°€ ë†’ì€ êµ¬í˜„ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

    ```java
      public class OxmSqlService implements SqlService {
    	
      	private final OxmSqlReader oxmSqlReader = new OxmSqlReader();
      
      	private SqlRegistry sqlRegistry = new HashMapSqlRegistry();
      
      	public void setSqlRegistry(SqlRegistry sqlRegistry) {
      		this.sqlRegistry = sqlRegistry;
      	}
      	//(1)
      	public void setUnmarshaller(Unmarshaller unmarshaller) {
      		this.oxmSqlReader.setUnmarshaller(unmarshaller);
      	}
      	//(2)
      	public void setSqlmapFile(String sqlmapFile) {
      		this.oxmSqlReader.setSqlmapFile(sqlmapFile);
      	}
      
      	@PostConstruct
      	public void loadSql() {
      		this.oxmsSqlReader.read(this.sqlRegistry);
      	}
      
      	public String getSql(String key) throws SqlRetrievalFailureException {
      		try {
      			return this.sqlRegistry.findSql(key);
      		} 
      		catch(SqlNotFoundException e) {
      			throw new SqlRetrievalFailureException(e);
      		}
      	}
      	
      	private class OxmSqlReader implements SqlReader {
      		private Unmarshaller unmarshaller;
      		private final static String DEFAULT_SQLMAP_FILE = "sqlmap.xml";
      		private String sqlmapFile = DEFAULT_SQLMAP_FILE;
      
      		public void setUnmarshaller(Unmarshaller unmarshaller) {
      			this.unmarshaller = unmarshaller;
      		}
      
      		public void setSqlmapFile(String sqlmapFile) {
      			this.sqlmapFile = sqlmapFile;
      		}
      
      		public void read(SqlRegistry sqlRegistry) {
      			try {
      				Source source = new StreamSource(UserDao.class.getResourceAsStream(this.sqlmapFile));
      				Sqlmap sqlmap = (Sqlmap)this.unmarshaller.unmarshal(source);
      				for(SqlType sql : sqlmap.getSql()) {
      					sqlRegistry.registerSql(sql.getKey(), sql.getValue());
      				}
      			} catch (IOException e) {
      				throw new IllegalArgumentException(this.sqlmapFile + "ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", e);
      			}
      		}
      	}
      }
    ```

    - (3),(4)ë¥¼ í†µí•´ í•˜ë‚˜ì˜ ë¹ˆ ì„¤ì •ë§Œìœ¼ë¡œ SqlServiceì™€ SqlReaderì˜ í•„ìš”í•œ í”„ë¡œí¼í‹° ì„¤ì •ì´ ëª¨ë‘ ê°€ëŠ¥í•˜ë„ë¡ í•œë‹¤. OxmSqlServiceì´ ë‚´ë¶€ ì˜¤ë¸Œì íŠ¸ì˜ í”„ë¡œí¼í‹°ë¥¼ ì „ë‹¬í•œë‹¤. ë•ë¶„ì— ë¹„ìŠ·í•œ êµ¬ì¡°ì˜ ë¹ˆì˜ ê°œìˆ˜ë¥¼ ì¤„ì´ê³  ì„¤ì •ì„ ë‹¨ìˆœí™”í•˜ë©°, í´ë˜ìŠ¤ êµ¬ì¡°ì²˜ëŸ¼ ë¹ˆ ì„¤ì • ë˜í•œ ê°•í•œ ê²°í•© êµ¬ì¡°ë¡œ ë‚˜íƒ€ë‚¸ë‹¤.

    ```xml
      <bean id="sqlService" class="springbook.user.sqlservice.OxmSqlService">
      	<property name="unmarshaller" ref="unmarshaller" /> 
      </bean>
      		
      <bean id="unmarshaller" class="org.springframework.oxm.jaxb.Jaxb2Marshaller">
      	<property name="contextPath" value="springbook.user.sqlservice.jaxb" />
      </bean>
    ```

    - OXMì„ ì¶”ìƒí™” í•˜ì˜€ì§€ë§Œ ì—¬ì „íˆ ì„¤ì •ì€ ê¹”ë”í•˜ë‹¤.

  - ìœ„ì„ì„ ì´ìš©í•œ BaseSqlServiceì˜ ì¬ì‚¬ìš©

    - loadSql(), getSql() ë©”ì†Œë“œê°€ BaseSqlServiceì™€ ë§¤ìš° ìœ ì‚¬í•˜ë‹¤. ì´ë¥¼ ì¬ì‚¬ìš©í•´ë³´ì
          1. BaseSqlServiceë¥¼ ìƒì† : ë‚´ë¶€ í´ë˜ìŠ¤ë¡œ ë§Œë“  OxmSqlReader ìƒì„± ì½”ë“œë¥¼ ë„£ê¸°ê°€ ì• ë§¤í•´ì§„ë‹¤.
          2. ì¤‘ë³µë˜ëŠ” ë©”ì†Œë“œë¥¼ ì¶”ì¶œí•´ì„œ ìŠˆí¼í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬ : ê²¨ìš° ìš”ì •ë„ ì¤‘ë³µìœ¼ë¡œ ê³„ì¸µêµ¬ì¡°ë¡œ ë§Œë“œëŠ”ê²ƒì€ ë¶€ë‹´ìŠ¤ëŸ½ë‹¤.
          3. ì¤‘ë³µ í—ˆìš© : ê°„ë‹¨í•œ ì¤‘ë³µì •ë„ëŠ” í—ˆìš©í•  ìˆ˜ ìˆìœ¼ë‚˜ ë§Œì•½ ì´ ë©”ì†Œë“œë“¤ì˜ ì‘ì—…ì´ ê½¤ë‚˜ ë³µì¡í•´ì§€ê³  ë³€ê²½ë„ ìì£¼ì¼ì–´ë‚˜ê²Œ ëœë‹¤ë©´ ì¤‘ë³µì„ í—ˆìš©í•  ìˆ˜ëŠ” ì—†ë‹¤.
    - ë¯¸ë˜ë¥¼ ëŒ€ë¹„í•˜ê¸° ìœ„í•´ ìœ„ì„ êµ¬ì¡°ë¥¼ í†µí•´ ì¤‘ë³µì„ ì œê±°í•´ ë³´ì!

    ```java
      public class OxmSqlService implements SqlService {
      	private final BaseSqlService baseSqlService = new BaseSqlService();
      	...
         
       	@PostConstruct
      	public void loadSql() {
      		this.baseSqlService.setSqlReader(this.oxmSqlReader);
      		this.baseSqlService.setSqlRegistry(this.sqlRegistry);
      		
      		this.baseSqlService.loadSql();
      	}
      
      	public String getSql(String key) throws SqlRetrievalFailureException {
      		return this.baseSqlService.getSql(key);
      	}
      }
    ```

      ê¹”ë”í•˜ê²Œ ì œê±°ë˜ì—ˆë‹¤.

  #### 7.3.3 ë¦¬ì†ŒìŠ¤ ì¶”ìƒí™”

  - XML íŒŒì¼ ì´ë¦„ì„ ì™¸ë¶€ì—ì„œ ì§€ì •í•  ìˆ˜ ìˆì§€ë§Œ UserDao í´ë˜ìŠ¤ì™€ ê°™ì€ ê²½ë¡œì— ì¡´ì¬í•˜ì—¬ì•¼ë§Œ í•œë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤. ì¢€ë” ë‹¤ì–‘í•œ ìœ„ì¹˜ì˜ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ë‹¨ì¼í™”ëœ ì ‘ê·¼ ì¸í„°í˜ì´ìŠ¤ê°€ ìˆìœ¼ë©´ ì¢‹ê² ì§€ë§Œ ìë°”ì—ëŠ” ì—†ë‹¤. :no_good_man: :cry:

  - Resource

    - ìë°”ì—ëŠ” ì—†ì§€ë§Œ ê·¸ê³³ì—ëŠ” ìˆë‹¤. ìœ„.ëŒ€.í•œ :sunny:ìŠ¤:sunflower:í”„:rose:ë§:cherry_blossom: 

    ```java
      package org.springframework.core.io;
      
      public interface Resource extends InputStreamSource {
      
      	boolean exists();
      	boolean isReadable();
      	boolean isOpen();
      
      	URL getURL() throws IOException;
      	URI getURI() throws IOException;
      	File getFile() throws IOException;
      
      	Resource createRelative(String relativePath) throws IOException;
      	
      	long lastModified() throws IOException;
      	String getFilename();
      	String getDescription();
      	...
      }
      public interface InputStreamSource {
      	InputStream getInputStream() throws IOException;
      }
    ```

    > [Resource.java](https://github.com/spring-projects/spring-framework/blob/master/spring-core/src/main/java/org/springframework/core/io/Resource.java)

    - ìŠ¤í”„ë§ì˜ ê±°ì˜ ëª¨ë“  APIëŠ” ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ ì •ë³´ê°€ í•„ìš”í• ë•Œ í•­ìƒ Resourceë¥¼ ì´ìš©í•œë‹¤.
    - ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ì¶”ìƒí™” ì˜¤ë¸Œì íŠ¸ì™€ ë‹¬ë¦¬ ResourceëŠ” ìŠ¤í”„ë§ì—ì„œ ë¹ˆì´ ì•„ë‹ˆë¼ ê°’ìœ¼ë¡œ ì·¨ê¸‰ë˜ê¸° ë•Œë¬¸ì— ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ì„ ìœ„í•´ ë§¤ë²ˆ ë¹ˆìœ¼ë¡œ ë“±ë¡í•  í•„ìš”ëŠ” ì—†ë‹¤.
    - ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì¶”ìƒí™”ë¥¼ ì ìš©í•˜ëŠ” ë°©ë²•ì´ ë¬¸ì œë‹¤. ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì™¸ë¶€ì—ì„œ ì§€ì •í• ìˆ˜ ìˆëŠ” ë°©ë²•ì€ <property>ì˜ value attributeì„ ì´ìš©í•˜ëŠ” ì •ë„ì§€ë§Œ ìš°ë¦¬ëŠ” ì´ê³³ì— ë‹¨ìˆœí•œ ë¬¸ìì—´ë§Œì„ ë„£ì„ ìˆ˜ ìˆë‹¤.

  - ResourceLoader

    - :sunny:ìŠ¤:sunflower:í”„:rose:ë§:cherry_blossom:ì—ëŠ” URL í´ë˜ìŠ¤ì™€ ìœ ì‚¬í•˜ê²Œ ì ‘ë‘ì–´ë¥¼ ì´ìš©í•´ Resourceì˜¤ë¸Œì íŠ¸ë¥¼ ì„ ì–¸í•˜ëŠ” ë°©ë²•ì´ ìˆë‹¤. ë¬¸ìì—´ë¡œ ì •ì˜ëœ ë¦¬ì†ŒìŠ¤ë¥¼ ì‹¤ì œ Resource ë¡œ ë³€í™˜í•´ ì£¼ëŠ” ê²ƒì„ ì¶”ê°€ë¡œ ì œê³µí•œë‹¤.

    ```java
      package org.springframework.core.io;
      
      public interface ResourceLoader {
      	Resource getResource(String location);
        ...
      }
    ```

    > [ResourceLoader.java](https://github.com/spring-projects/spring-framework/blob/master/spring-core/src/main/java/org/springframework/core/io/ResourceLoader.java)

    - ResourceLoaderê°€ ì²˜ë¦¬í•˜ëŠ” ì ‘ë‘ì–´ì˜ ì˜ˆ

    | prefix     | example                          | description                                                  |
    | ---------- | -------------------------------- | ------------------------------------------------------------ |
    | file:      | file:/C:/temp/file.txt           | íŒŒì¼ ì‹œìŠ¤í…œì˜ C:temp í´ë”ì˜ file.txtë¥¼ ë¦¬ì†ŒìŠ¤ë¡œ ë§Œë“¤ì–´ì¤€ë‹¤.  |
    | classpath: | classpath:file.txt               | í´ë˜ìŠ¤íŒ¨ìŠ¤ì˜ ë£¨íŠ¸ì— ì¡´ì¬í•˜ëŠ” file.txt ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•˜ê²Œ í•´ì¤€ë‹¤. |
    | (ì—†ìŒ)     | WEB-INF/test.dat                 | ì ‘ë‘ì–´ê°€ ì—†ëŠ” ê²½ìš° ResourceLoader êµ¬í˜„ì— ë”°ë¼ ë¦¬ì†ŒìŠ¤ì˜ ìœ„ì¹˜ê°€ ê²°ì •ëœë‹¤. ServletResourceLoaderì˜ ê²½ìš° ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ì˜ ë£¨íŠ¸ê°€ ê¸°ì¤€ |
    | http:      | http://www.myserver.com/test.dat | HTTP í”„ë¡œí† ì½œì„ ì´ìš©í•˜ì—¬ ì›¹ìƒì˜ ë¦¬ì†ŒìŠ¤ ì§€ì • (ftp: ë„ ê°€ëŠ¥)   |

    - ApplicationContext ëŠ” ResourceLoader ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì†í•˜ê³  ìˆìœ¼ë©° ê°€ì¥ ëŒ€í‘œì ì¸ ì˜ˆì´ë‹¤.

  - Resourceë¥¼ ì´ìš©í•´ XML íŒŒì¼ ê°€ì ¸ì˜¤ê¸°

    - OxmSqlServiceì— Resourceë¥¼ ì ìš©í•´ë³´ì!

    ```java
    public class OxmSqlService implements SqlService {
    	...
    	public void setSqlmap(Resource sqlmap) {
    		this.oxmSqlReader.setSqlmap(sqlmap);
    	}
      
    	private class OxmSqlReader implements SqlReader {
    		private Resource sqlmap = new ClassPathResource("sqlmap.xml", UserDao.class);
    
    		public void setSqlmap(Resource sqlmap) {
    			this.sqlmap = sqlmap;
    		}
    
    		public void read(SqlRegistry sqlRegistry) {
    			try {
    				Source source = new StreamSource(sqlmap.getInputStream());
    				}
    			} catch (IOException e) {
    				...
    			}
    		}
    	}
    }
    ```

    ```xml
    <bean id="sqlService" class="springbook.user.sqlservice.OxmSqlService">
    	<property name="unmarshaller" ref="unmarshaller" /> 
    	<property name="sqlmap" value="classpath:/springbook/user/dao/sqlmap.xml" />
    </bean>
    ```

    

    - ResourceëŠ” ì‹¤ì œ ë¦¬ì†ŒìŠ¤ê°€ ì•„ë‹Œ ì¶”ìƒí™” ëœ í•¸ë“¤ëŸ¬ë€ ê²ƒì— ì£¼ì˜í•˜ì.
    - ë‹¤ìŒê³¼ ê°™ì€ ì‹ë„ ê°€ëŠ¥í•˜ë‹¤.

    ```xml
    <bean id="sqlService" class="springbook.user.sqlservice.OxmSqlService">
    	<property name="unmarshaller" ref="unmarshaller" /> 
    	<property name="sqlmap" value="file:/pot/resource/sqlmap.xml" />
    </bean>
    
    <bean id="sqlService" class="springbook.user.sqlservice.OxmSqlService">
    	<property name="unmarshaller" ref="unmarshaller" /> 
    	<property name="sqlmap" value="http://www.epril.com/resources/sqlmap.xml" />
    </bean>
    ```

## 7.4 ì¸í„°í˜ì´ìŠ¤ ìƒì†ì„ í†µí•œ ì•ˆì „í•œ ê¸°ëŠ¥ í™•ì¥

- ì„œë²„ì˜ ì¬ì‹œì‘ì—†ì´ ê¸´ê¸‰í•˜ê²Œ ì‚¬ìš©ì¤‘ì¸ SQLì„ ë³€ê²½í•´ì•¼í•œë‹¤.

  > ì§€ê¸ˆê¹Œì§€ì˜ SqlService êµ¬í˜„ í´ë˜ìŠ¤ë“¤ì€ ì´ˆê¸°ì— ë¦¬ì†ŒìŠ¤ë¡œë¶€í„° SQL ì •ë³´ë¥¼ ì½ì–´ì„œ ì´ë¥¼ ë©”ëª¨ë¦¬ì— ë‘ê³  ê·¸ëŒ€ë¡œ ì‚¬ìš©í•œë‹¤. ì¦‰ SQL ë§¤í•‘ì •ë³´íŒŒì¼ì„ ë³€ê²½í•œë‹¤ê³  ë©”ëª¨ë¦¬ì˜ SQL ì •ë³´ê°€ ê°±ì‹ ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ëœ»ì´ë‹¤. SQL ì •ë³´ì˜ ì‹¤ì‹œê°„ ë³€ê²½ ê¸°ëŠ¥ ì¶”ê°€ë¥¼ ìœ„í•´ SqlService êµ¬í˜„ í´ë˜ìŠ¤ ë° ì¸í„°í˜ì´ìŠ¤ë¥¼ ëœ¯ì–´ê³ ì³ì•¼ í• ì§€ë„ ëª¨ë¥¸ë‹¤. ìŠ¤í”„ë§ë‹µê²Œ ì ‘ê·¼í•´ë´…ì‹œë‹¹.

  #### 7.4.1 DIì™€ ê¸°ëŠ¥ì˜ í™•ì¥

  ```
  ì§€ê¸ˆê¹Œì§€ ì ìš©í•´ì˜¨ DIëŠ” íŠ¹ë³„í•œ ê¸°ìˆ ì´ë¼ê¸°ë³´ë‹¤ëŠ” ì¼ì¢…ì˜ ë””ìì¸íŒ¨í„´ ë˜ëŠ” í”„ë¡œê·¸ë˜ë° ëª¨ë¸ì´ë¼ëŠ” ê´€ì ì´ ë” ìì—°ìŠ¤ëŸ½ë‹¤. ê·¸ë˜ì„œ ë‹¨ì§€ ìŠ¤í”„ë§ê³¼ ê°™ì€ DI í”„ë ˆì„ì›Œí¬ë¥¼ ì ìš©í•˜ê³  ë¹ˆ ì„¤ì •íŒŒì¼ì„ ì´ìš©í•´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ì„±í–ˆë‹¤ê³  í•´ì„œ DIë¥¼ ë°”ë¥´ê²Œ í™œìš©í•˜ê³  ìˆëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤. DIì˜ ê°€ì¹˜ë¥¼ ì œëŒ€ë¡œ ì–»ê¸° ìœ„í•´ì„œëŠ” DIì— ì í•©í•œ ì˜¤ë¸Œì íŠ¸ ì„¤ê³„ê°€ í•„ìš”í•˜ë‹¤.
  ```

  - DIë¥¼ ì˜ì‹í•˜ëŠ” ì„¤ê³„
    - DIì™€ ì¢‹ì€ ì˜¤ë¸Œì íŠ¸ ì„¤ê³„ëŠ” í•¨ê²Œ ìƒìŠ¹ ì‘ìš©ì„ í•œë‹¤.
    - DIë¥¼ ì˜ì‹í•˜ë©° ì„¤ê³„í•˜ë©´ ì¢‹ì€ ì˜¤ë¸Œì íŠ¸ë¥¼ ì„¤ê³„í•  ìˆ˜ ìˆë‹¤. ë²„ë¦‡ì„ ë“¤ì…ì‹œë‹¤.
  - DIì™€ ì¸í„°í˜ì´ìŠ¤ í”„ë¡œê·¸ë˜ë°
    - DI ì ìš©ì‹œì—ëŠ” ê°€ëŠ¥í•œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê²Œ í•´ì•¼ í•œë‹¤.
      1. ë‹¤í˜•ì„±ì„ ì–»ê¸° ì‰½ë‹¤.
      2. ì¸í„°í˜ì´ìŠ¤ ë¶„ë¦¬ì›ì¹™ì„ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì™€ ì˜ì¡´ ì˜¤ë¸Œì íŠ¸ ì‚¬ì´ì˜ ê´€ê³„ë¥¼ ëª…í™•íˆ í•œë‹¤.
    - (Tip :star: : ëˆ„êµ°ê°€ê°€ ì¸í„°í˜ì´ìŠ¤ ê¼­ ì¨ì•¼í•˜ëƒê³  ëŒë¹Œë•Œ ì´ê¸¸ ìì‹  ì—†ìœ¼ë©´ DIëŠ” ì›ë˜ ì¸í„°í˜ì´ìŠ¤ ì“°ê²Œë˜ì–´ ìˆë‹¤ê³  ìš°ê²¨ë„ ì¢‹ë‹¤.)

  #### 7.4.2 ì¸í„°í˜ì´ìŠ¤ ìƒì†

  - ì¸í„°í˜ì´ìŠ¤ ì—¬ëŸ¬ ê°œ ë§Œë“œëŠ” ëŒ€ì‹  ê¸°ì¡´ ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì†í•˜ì—¬ í™•ì¥ í•˜ëŠ” ë°©ë²•ë„ ì‚¬ìš©ëœë‹¤.

    ![](https://studyteamthree.github.io/SpringStudy/assets/img/7.4.2_Interface_DI.PNG)

    - BaseSqlService ì˜ êµ¬ì¡°ì´ë‹¤. SqlRegistryë¥¼ í†µí•´ MySqlRegistry í´ë˜ìŠ¤ì— ì ‘ê·¼í•˜ë¯€ë¡œ MySqlRegistry êµ¬í˜„ ë‚´ìš©ì— ì˜í–¥ì„ ë°›ì§€ ì•ŠëŠ”ë‹¤.
    - MySqlRegistryê°€ í™•ì¥ë˜ë©´ì„œ ë‹¤ë¥¸ ì¸í„°í˜ì´ìŠ¤ê°€ í•„ìš”í•´ì¡Œì„ë•Œ, ê¼­ ìƒˆë¡œìš´ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“œëŠ” ê²ƒë³´ë‹¤ëŠ” ê¸°ì¡´ ì¸í„°í˜ì´ìŠ¤ë¥¼ í™•ì¥í•˜ëŠ” ë°©ë²•ë„ ìˆë‹¤.

    ```java
    package springbook.user.sqlservice;
    
    public interface SqlRegistry {
    	void registerSql(String key, String sql);
    
    	String findSql(String key) throws SqlNotFoundException;
    }
    
    
    public interface UpdatableSqlRegistry extends SqlRegistry {
    	public void updateSql(String key, String sql) throws SqlUpdateFailureException;
    	
    	public void updateSql(Map<String, String> sqlmap) throws SqlUpdateFailureException;
    }
    
    ```

    - ìš”ë ‡ê²Œ í™•ì¥í•´ì„œ ì“°ë©´ ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ê°€ ëœë‹¤.

    ![](https://studyteamthree.github.io/SpringStudy/assets/img/7.4.2_InterfaceInheritance.PNG)

    - BaseSqlService, SqlAdminServiceëŠ” ë™ì¼ ì˜¤ë¸Œì íŠ¸ì— ì˜ì¡´í•˜ì§€ë§Œ ê°ìì˜ ê´€ì‹¬ì— ë”°ë¼ ë‹¤ë¥¸ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì ‘ê·¼í•œë‹¤.
    - ê²°ë¡  : ì´ë ‡ê²Œ í™•ì¥ì„ ì˜ ì´ìš©í•˜ë©´ ê¸°ì¡´ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ìƒˆë¡œìš´ í´ë¼ì´ì–¸íŠ¸ê°€ ë‚˜íƒ€ë‚˜ë„ ìœ ì—°í•˜ê²Œ ëŒ€ì‘ ê°€ëŠ¥í•˜ë‹¤.! :thumbsup:

## 7.5 DIë¥¼ ì´ìš©í•´ ë‹¤ì–‘í•œ êµ¬í˜„ ë°©ë²• ì ìš©í•˜ê¸°

- ì¸í„°í˜ì´ìŠ¤ ë¶„ë¦¬ì›ì¹™ì„ ì˜ ì§€í‚¤ëŠ” êµ¬ì¡°ë¥¼ ë³´ì•˜ìœ¼ë‹ˆ ì‹¤ì œ êµ¬í˜„í•´ë³´ì.

  > ê¸°ì¡´ì˜ SqlRegistryì—ì„œëŠ” í•œë²ˆ ì´ˆê¸°í™” í•˜ê³  ê·¸ ë’¤ì— ì½ê¸° ì „ìš©ìœ¼ë¡œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ì ‘ê·¼í•˜ë©´ ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•  ì¼ì´ ì—†ì§€ë§Œ, ìˆ˜ì •ì„ í•˜ê²Œ ëœë‹¤ë©´ ì–´ëŠ ìˆœê°„ ê¹¨ì§„ SQLì´ ë‚˜íƒ€ë‚˜ë©° ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ë™ì‹œì„± ë¬¸ì œì— ëŒ€í•´ ê¹Šê²Œ ë‹¤ë£¨ì§„ ì•Šê² ì§€ë§Œ ìë°”ì—ì„œ ì œê³µë˜ëŠ” ì£¼ìš” ê¸°ìˆ ì„ í†µí•´ ì–´ëŠì •ë„ ì•ˆì „í•˜ê²Œ ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ì–´ë³´ì!

  #### 7.5.1 ConcurrentHashMapì„ ì´ìš©í•œ ìˆ˜ì • ê°€ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬

  - HashMapRegistryëŠ” JDKì˜ HashMapì„ ì‚¬ìš©í•˜ë©° ì´ëŠ” ë©€í‹° ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©° ì•ˆì „í•œ ì‚¬ìš©ì„ ìœ„í•´ ì™¸ë¶€ì—ì„œ ë™ê¸°í™”í•˜ë©´ ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí•œë‹¤. ê·¸ë˜ì„œ ì¼ë°˜ì ìœ¼ë¡œ ConcurrentHashë§µì„ ì´ìš©í•œë‹¤.

  - ìˆ˜ì • ê°€ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ í…ŒìŠ¤íŠ¸

    - UpdatableSqlRegistry êµ¬í˜„ ì „ í…ŒìŠ¤íŠ¸ë¥¼ í•´ì•¼í•œë‹¤.
    - UserDaoTestë¡œëŠ” ì•ˆë˜ë‹ˆ ë‹¤ì‹œ ë§Œë“¤ì

    ```java
    public class ConcurrentHashMapSqlRegistryTest {
    	UpdatableSqlRegistry sqlRegistry;
    	
    	@Before
    	public void setUp() {
    		sqlRegistry = new ConcurrentHashMapSqlRegistry();
    		sqlRegistry.registerSql("KEY1", "SQL1");
    		sqlRegistry.registerSql("KEY2", "SQL2");
    		sqlRegistry.registerSql("KEY3", "SQL3");
    	}
    	
    	@Test
    	public void find() {
    		checkFindResult("SQL1", "SQL2", "SQL3");
    	}
    
    	private void checkFindResult(String expected1, String expected2, String expected3) {
    		assertThat(sqlRegistry.findSql("KEY1"), is(expected1));		
    		assertThat(sqlRegistry.findSql("KEY2"), is(expected2));		
    		assertThat(sqlRegistry.findSql("KEY3"), is(expected3));		
    	}
    	
    	@Test(expected= SqlNotFoundException.class)
    	public void unknownKey() {
    		sqlRegistry.findSql("SQL9999!@#$");
    	}
    			
    	@Test
    	public void updateSingle() {
    		sqlRegistry.updateSql("KEY2", "Modified2");		
    		checkFindResult("SQL1", "Modified2", "SQL3");
    	}
    	
    	@Test
    	public void updateMulti() {
    		Map<String, String> sqlmap = new HashMap<String, String>();
    		sqlmap.put("KEY1", "Modified1");
    		sqlmap.put("KEY3", "Modified3");
    		
    		sqlRegistry.updateSql(sqlmap);		
    		checkFindResult("Modified1", "SQL2", "Modified3");
    	}
    
    	@Test(expected=SqlUpdateFailureException.class)
    	public void updateWithNotExistingKey() {
    		sqlRegistry.updateSql("SQL9999!@#$", "Modified2");
    	}
    }
    ```

    â€‹	ë™ì‹œì„±ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ëŠ” ê°„ë‹¨í•˜ì§€ ì•Šìœ¼ë‹ˆê¹Œ ìš”ì •ë„ë¡œ ë§Œì¡± í•©ë‹ˆë‹¤.

  - ìˆ˜ì • ê°€ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ êµ¬í˜„

    - ê¸°ì¡´ HashMapì„ ConcurentHashMapìœ¼ë¡œ ë³€ê²½í•˜ê³  ì¶”ê°€ëœ ë©”ì†Œë“œë¥¼ êµ¬í˜„í•˜ì˜€ë‹¤.

    ```java
    public class ConcurrentHashMapSqlRegistry implements UpdatableSqlRegistry {
    	private Map<String, String> sqlMap = new ConcurrentHashMap<String, String>();
    
    	public String findSql(String key) throws SqlNotFoundException {
    		String sql = sqlMap.get(key);
    		if (sql == null)  throw new SqlNotFoundException(key + "ë¥¼ ì´ìš©í•´ì„œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    		else return sql;
    	}
    
    	public void registerSql(String key, String sql) { sqlMap.put(key, sql);	}
    
    	public void updateSql(String key, String sql) throws SqlUpdateFailureException {
    		if (sqlMap.get(key) == null) {
    			throw new SqlUpdateFailureException(key + "ì— í•´ë‹¹ë˜ëŠ” SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    		}
    		
    		sqlMap.put(key, sql);
    	}
    
    	public void updateSql(Map<String, String> sqlmap) throws SqlUpdateFailureException {
    		for(Map.Entry<String, String> entry : sqlmap.entrySet()) {
    			updateSql(entry.getKey(), entry.getValue());
    		}
    	}
    }
    ```

    - OxmSqlServiceëŠ” HashMApSqlRegistryë¥¼ ë””í´íŠ¸ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ ë¹ˆ ì„¤ì •ë„ í•´ì£¼ì

    ```xml
    <bean id="sqlService" class="springbook.user.sqlservice.OxmSqlService">
    	<property name="unmarshaller" ref="unmarshaller" /> 
    	<property name="sqlRegistry" ref="sqlRegistry" />
    </bean>
    	
    <bean id="sqlRegistry" class="springbook.user.sqlservice.updatable.ConcurrentHashMapSqlRegistry">
    </bean>
    ```

    â€‹	ë°”ê¾¼ í›„ UserDaoTestë¥¼ í†µí•´ í†µí•©í…ŒìŠ¤íŠ¸ë„ í•´ë³´ì!

  #### 7.5.2 ë‚´ì¥í˜• ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì´ìš©í•œ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë§Œë“¤ê¸°

  - ConcurrentHashMap ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•˜ë‹ˆ ë‚´ì¥í˜• DBë¥¼ ì´ìš©í•´ë³´ì

  ```
  ë‚´ì¥í˜• DB : ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë‚´ì¥ë˜ì–´ ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ì‹œì‘ë˜ê³  ì¢…ë£Œë˜ëŠ” DB, ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ë¯€ë¡œ IOë¡œ ì¸í•œ ë¶€í•˜ê°€ ì ì–´ì„œ ì„±ëŠ¥ì´ ë›°ì–´ë‚¨. ë˜í•œ ë“±ë¡, ìˆ˜ì • ê²€ìƒ‰ ë“±ë„ íš¨ê³¼ì ì´ë©° ì•ˆì •ì ì´ê³ , ë½í‚¹, íŠ¸ëœì­ì…˜ ë“±ë„ ì ìš© ê°€ëŠ¥í•˜ë‹¤.
  ```

  - ìŠ¤í”„ë§ì˜ ë‚´ì¥í˜• DB ì§€ì› ê¸°ëŠ¥

    - ìë°”ì—ì„œ ë§ì´ ì‚¬ìš© ë˜ëŠ” ë‚´ì¥í˜• DBì¸ Derby, HSQL, H2 ë“±ì€ JDBCë“œë¼ì´ë²„ ì œê³µ ë° í‘œì¤€ DBì™€ í˜¸í™˜ë˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤
    - ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ìƒëª…ì£¼ê¸°ë¥¼ ê°™ì´ í•˜ë©° ì´ˆê¸°í™” ì‘ì—…ì´ ë³„ë„ë¡œ í•„ìš”í•˜ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ê¸°ì¡´ì˜ DataSourceì™€ DAOë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë¸ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ëŠ”ê±´ ì¢‹ì§€ ì•Šë‹¤.
    - ìŠ¤í”„ë§ì€ ë‚´ì¥í˜• DBë¥¼ ìœ„í•œ ì„œë¹„ìŠ¤ ì¶”ìƒí™” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤ (ë³„ë„ ë ˆì´ì–´ë‚˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ì§€ëŠ” ì•ŠìŒ) :arrow_right: ì´ˆê¸°í™” ì‘ì—…ë§Œ ì§€ì›í•˜ë©´ ë˜ê¸° ë•Œë¬¸

  - ë‚´ì¥í˜• DB ë¹Œë” í•™ìŠµ í…ŒìŠ¤íŠ¸

    - í•™ìŠµ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ë™ì‘ì„ ì‚´í´ë³´ì! 
    - ì§ì ‘ ì‚´í´ë³´ì :book::school::yum:

  - ë‚´ì¥í˜• DBë¥¼ ì´ìš©í•œ SqlRegistry

    - EmbeddedDatabaseBuilderë¥¼ í™œìš©í•´ì„œ EmbeddedDataBase ì˜¤ë¸Œì íŠ¸ë¥¼ ìƒì„±í•´ì£¼ëŠ” íŒ©í† ë¦¬ ë¹ˆì„ ë§Œë“¤ì.

    ```xml
    <jdbc:embedded-database id="embeddedDatabase" type ="HSQL">
    	<jdbc:script location="classpath:schema.sql"/>
    </jdbc:embedded-database>
    ```

    - ë‚´ì¥í˜• DBì˜ DataSourceë¥¼ ë°›ì•„ì„œ ë§Œë“  í´ë˜ìŠ¤ ì½”ë“œì´ë‹¤

    ```java
    public class EmbeddedDbSqlRegistry implements UpdatableSqlRegistry {
    	SimpleJdbcTemplate jdbc;
    	
    	public void setDataSource(DataSource dataSource) {
    		jdbc = new SimpleJdbcTemplate(dataSource);
    	}
    	
    	public void registerSql(String key, String sql) {
    		jdbc.update("insert into sqlmap(key_, sql_) values(?,?)", key, sql);
    	}
    
    	public String findSql(String key) throws SqlNotFoundException {
    		try {
    			return jdbc.queryForObject("select sql_ from sqlmap where key_ = ?", String.class, key);
    		}
    		catch(EmptyResultDataAccessException e) {
    			throw new SqlNotFoundException(key + ì— í•´ë‹¹í•˜ëŠ” SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", e);
    		}
    	}
    
    	public void updateSql(String key, String sql) throws SqlUpdateFailureException {
    		int affected = jdbc.update("update sqlmap set sql_ = ? where key_ = ?" , sql, key);
    		if (affected == 0) {
    			throw new SqlUpdateFailureException(key + "ì— í•´ë‹¹í•˜ëŠ” SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    		}
    	}
    
    	public void updateSql(Map<String, String> sqlmap) throws SqlUpdateFailureException {
    		for(Map.Entry<String, String> entry : sqlmap.entrySet()) {
    			updateSql(entry.getKey(), entry.getValue());
    		}
    	}
    }
    ```

    â€‹	ì „í˜•ì ì¸ JDBC crudì´ë‹¤.

  - UpdatableSqlRegistry í…ŒìŠ¤íŠ¸ ì½”ë“œì˜ ì¬ì‚¬ìš©

    - ìœ„ì—ì„œ ë§Œë“  EmbeddedSqlRegisrtyë„ í…ŒìŠ¤íŠ¸ë¥¼ í•´ì•¼í•œë‹¤.
    - ConcurrentHashMapSqlRegistryTestì™€ ë¹„ìŠ·í•˜ê²Œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ ë¼, ë‚´ìš© ì¤‘ë³µì´ ë§ì„ ê²ƒì´ë¯€ë¡œ ë‚´ìš©ì„ ê³µìœ í•˜ê²Œ ë§Œë“¤ì (ìƒì†)
    - TDD ëŠ” ì •ë§ ì¤‘ìš”í•˜ê³  â˜€ï¸ìµœğŸ˜„ê³ ğŸ‘ë‹ˆê¹Œ ì§ì ‘ í•´ë³´ëŠ”ê±¸ë¡œ í•˜ê³  ì €ëŠ” ìƒëµ ã…ã…

  - XML ì„¤ì •ì„ í†µí•œ ë‚´ì¥í˜• DBì˜ ìƒì„±ê³¼ ì ìš©

    - EmbeddedDbSqlRegistryë¥¼ ì ìš©í•´ë´…ì‹œë‹¤. jdbcìŠ¤í‚¤ë§ˆì˜ ì „ìš© íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ë©´ í¸í•˜ë‹¤.

    ```xml
    <beans
           ...
    	xmlns:jdbc="http://www.springframework.org/schema/jdbc"
    	xsi:schemaLocation="http://www.springframework.org/schema/tx/spring-tx-3.0.xsd 
    		http://www.springframework.org/schema/jdbc
                            ...">
    	
    <jdbc:embedded-database id="embeddedDatabase" type="HSQL">
    	<jdbc:script location="classpath:springbook/user/sqlservice/updatable/sqlRegistrySchema.sql"/>
    </jdbc:embedded-database>
        
    <bean id="sqlService" class="springbook.user.sqlservice.OxmSqlService">
    	<property name="unmarshaller" ref="unmarshaller" /> 
    	<property name="sqlRegistry" ref="sqlRegistry" />
    </bean>
    
    <bean id="sqlRegistry" class="springbook.user.sqlservice.updatable.EmbeddedDbSqlRegistry">
    	<property name="dataSource" ref="embeddedDatabase" />
    </bean>
    
    <jdbc:embedded-database id="embeddedDatabase" type="HSQL">
    	<jdbc:script location="classpath:springbook/user/sqlservice/updatable/sqlRegistrySchema.sql"/>
    </jdbc:embedded-database>
    ```

    - ì ìš© í›„ì—” ê¼­ UserDaoTestë¥¼ ì‹¤í–‰í•´ì„œ ì´ìƒì—¬ë¶€ë¥¼ í™•ì¸í•˜ì.!

  #### 7.5.3 íŠ¸ëœì­ì…˜ ì ìš©

  - í˜„ì¬ updateSql() ë©”ì†Œë“œëŠ” SimpleJdbcTemplateë¥¼ ì‚¬ìš©ì¤‘ì´ë¯€ë¡œ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì–´ ìˆì§€ ì•Šë‹¤. ì œí•œ ëœ ì˜¤ë¸Œì íŠ¸ ë‚´ì˜ íŠ¹í™”ëœ ê°„ë‹¨í•œ íŠ¸ëœì­ì…˜ì´ë¯€ë¡œ AOPê°™ì´ ê±°ì°½í•œ ë°©ë²• ë³´ë‹¤ëŠ” ì¶”ìƒí™” APIë¥¼ ì‚¬ìš©í•´ë³´ì

  ```
  ìš´ì˜ ì¤‘ì¸ ì‹œìŠ¤í…œì—ì„œ SQLì„ ë³€ê²½ í• ë•ŒëŠ” SQLë“¤ì´ ì„œë¡œ ê´€ë ¨ì´ ìˆì„ ê²ƒì´ê¸° ë•Œë¬¸ì— ì—¬ëŸ¬ SQLì„ ìˆ˜ì •í•´ì•¼ í•  ê²ƒì´ë‹¤. ì´ë•Œ ì¼ë¶€ë§Œ ì ìš© ë˜ì—ˆì„ ë•Œ ìœ„í—˜í•œ ê²°ê³¼ë¥¼ ì´ˆë˜í•˜ë¯€ë¡œ ìˆ˜ì •ì‘ì—…ì€ ê¼­ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì¼ì–´ë‚˜ì•¼ í•œë‹¤.
  ```

  - ë‹¤ì¤‘ SQL ìˆ˜ì •ì— ëŒ€í•œ íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸

    - T.D.D... 
    - íŠ¸ëœ ì­ì…˜ì˜ ì ìš©ì€ ìˆ˜ë™ìœ¼ë¡œ ê²€ì¦í•˜ê¸° ë§¤ìš° í˜ë“œë¯€ë¡œ, íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ë©´ ì„±ê³µí•˜ê³  ì•„ë‹ˆë¼ë©´ ì‹¤íŒ¨í•˜ë„ë¡ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ì.

  - ì½”ë“œë¥¼ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ì ìš©

    - í…ŒìŠ¤íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìœ¼ë‹ˆ íŠ¸ëœì­ì…˜ì„ ë³¸ê²©ì ìœ¼ë¡œ ì¶”ê°€í•˜ì. PlatfromTransactionManager ë³´ë‹¤ëŠ” ê°„ê²°í•œ TransactionTemplateì„ ì‚¬ìš©í•˜ì.

    ```java
    public class EmbeddedDbSqlRegistry implements UpdatableSqlRegistry {
    	SimpleJdbcTemplate jdbc;
    	TransactionTemplate transactionTemplate;
    	
    	public void setDataSource(DataSource dataSource) {
    		jdbc = new SimpleJdbcTemplate(dataSource);
    		transactionTemplate = new TransactionTemplate(
    								new DataSourceTransactionManager(dataSource));
    		transactionTemplate.setIsolationLevel(TransactionTemplate.ISOLATION_READ_COMMITTED);
    	}
    	
    	...
    
    	public void updateSql(final Map<String, String> sqlmap) throws SqlUpdateFailureException {
    		transactionTemplate.execute(new TransactionCallbackWithoutResult() {
    			protected void doInTransactionWithoutResult(TransactionStatus status) {
    				for(Map.Entry<String, String> entry : sqlmap.entrySet()) {
    					updateSql(entry.getKey(), entry.getValue());
    				}
    			}
    		});
    	}
    }
    ```

    - ì œëŒ€ë¡œ ì ìš© ëëŠ”ì§€ ê¼­ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´…ì‹œë‹¤. :white_check_mark::white_check_mark::white_check_mark:
